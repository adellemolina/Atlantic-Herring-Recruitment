
##      Title:            Atlantic Herring SA Data
##      Script Purpose:   Prepare herring time series with lags
##      Author:           Adelle Molina
##      Created:          7/22/22
##      Updated:          8/31/22
##      Notes:            This includes stock recruit data as well

# Libraries ---------------------------------------------------------------
library(dplyr)
library(ggplot2)
library(ggpubr)

# Manually import variables from ASAP model ------------------------------------
herring = structure(list(
  year = c(1965, 1966, 1967, 1968, 1969, 1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, 1979, 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989, 
           1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 
           2015, 2016, 2017, 2018, 2019, 2020, 2021),
  recruits = c(4.864754e+006, 3.913303e+006, 8.418418e+006, 4.027622e+006, 5.201490e+006, 2.475948e+006, 1.467439e+007, 2.562144e+006, 2.866499e+006, 3.507926e+006, 2.132604e+006, 2.565756e+006, 5.527145e+006, 5.771979e+006, 9.022276e+005, 3.973672e+006, 2.069876e+006, 1.921318e+006, 1.359330e+006, 4.504452e+006, 3.675050e+006, 3.223908e+006, 4.289285e+006, 6.276145e+006, 7.311144e+006, 
               7.794697e+006, 6.605043e+006, 3.360277e+006, 3.367537e+006, 3.707747e+006, 1.060684e+007, 4.650978e+006, 4.515168e+006, 2.864188e+006, 7.535893e+006, 2.209808e+006, 2.103963e+006, 4.495514e+006, 5.469233e+006, 2.949779e+006, 2.163047e+006, 4.575145e+006, 1.458040e+006, 2.773981e+006, 1.036147e+007, 1.995011e+006, 1.941889e+006, 6.115507e+006, 1.370991e+006, 1.316059e+006, 
               7.049114e+005, 3.435258e+005, 8.597470e+005, 6.927995e+005, 1.570989e+006, 8.637931e+005, 2.144506e+006),
  R.no.devs = c(3.051852e+006, 3.051852e+006, 3.052789e+006, 3.052839e+006, 3.052007e+006, 3.049923e+006, 3.047958e+006, 3.044345e+006, 3.042181e+006, 3.048009e+006, 3.044520e+006, 3.038618e+006, 3.033022e+006, 3.019695e+006, 2.998879e+006, 3.014066e+006, 3.009700e+006, 3.010080e+006, 3.001299e+006, 3.003036e+006, 3.002436e+006, 3.016398e+006, 3.022155e+006, 3.030740e+006, 3.030537e+006, 
                3.033298e+006, 3.033234e+006, 3.037982e+006, 3.044090e+006, 3.045528e+006, 3.043841e+006, 3.041957e+006, 3.040509e+006, 3.048207e+006, 3.045852e+006, 3.043410e+006, 3.044128e+006, 3.045739e+006, 3.042645e+006, 3.039240e+006, 3.040606e+006, 3.041675e+006, 3.037564e+006, 3.036944e+006, 3.037121e+006, 3.028771e+006, 3.026175e+006, 3.036045e+006, 3.040205e+006, 3.036605e+006, 
                3.042903e+006, 3.039353e+006, 3.030069e+006, 3.020596e+006, 2.999424e+006, 2.986980e+006, 2.984785e+006),
  logR.dev = c(4.662674e-001, 2.486331e-001, 1.014366e+000, 2.771040e-001, 5.331457e-001, -2.084930e-001, 1.571632e+000, -1.724412e-001, -5.948348e-002, 1.405364e-001, -3.559993e-001, -1.691496e-001, 6.001118e-001, 6.478591e-001, -1.201127e+000, 2.764007e-001, -3.743519e-001, -4.489552e-001, -7.920529e-001, 4.054424e-001, 2.021429e-001, 6.653083e-002, 3.501500e-001, 7.279491e-001, 8.806600e-001, 
               9.437933e-001, 7.782042e-001, 1.008297e-001, 1.009797e-001, 1.967501e-001, 1.248378e+000, 4.245765e-001, 3.954175e-001, -6.226842e-002, 9.058968e-001, -3.200731e-001, -3.693919e-001, 3.893366e-001, 5.864113e-001, -2.987703e-002, -3.405391e-001, 4.082298e-001, -7.339628e-001, -9.056839e-002, 1.227184e+000, -4.175076e-001, -4.436381e-001, 7.002721e-001, -7.963913e-001, -8.360980e-001, 
               -1.462495e+000, -2.180138e+000, -1.259703e+000, -1.472469e+000, -6.467147e-001, -1.240685e+000, -3.306184e-001),
  SR.std.resid = c(5.600442e-001, 2.986388e-001, 1.218378e+000, 3.328358e-001, 6.403733e-001, -2.504257e-001, 1.887722e+000, -2.071230e-001, -7.144694e-002, 1.688014e-001, -4.275987e-001, -2.031694e-001, 7.208078e-001, 7.781581e-001, -1.442700e+000, 3.319911e-001, -4.496425e-001, -5.392502e-001, -9.513524e-001, 4.869860e-001, 2.427984e-001, 7.991167e-002, 4.205730e-001, 8.743560e-001, 1.057780e+000, 
                   1.133611e+000, 9.347185e-001, 1.211089e-001, 1.212890e-001, 2.363210e-001, 1.499455e+000, 5.099683e-001, 4.749448e-001, -7.479199e-002, 1.088093e+000, -3.844469e-001, -4.436849e-001, 4.676409e-001, 7.043518e-001, -3.588598e-002, -4.090292e-001, 4.903340e-001, -8.815791e-001, -1.087837e-001, 1.473998e+000, -5.014778e-001, -5.328637e-001, 8.411125e-001, -9.565635e-001, -1.004256e+000, 
                   -1.756636e+000, -2.618612e+000, -1.513057e+000, -1.768615e+000, -7.767836e-001, -1.490215e+000, -3.971132e-001),
  SSB = c(9.753591e+005, 1.289719e+006, 1.312431e+006, 1.016283e+006, 6.492272e+005, 4.840740e+005, 3.296430e+005, 2.766896e+005, 4.872840e+005, 3.348256e+005, 2.187105e+005, 1.644389e+005, 1.031168e+005, 6.488890e+004, 8.900813e+004, 8.044368e+004, 8.112356e+004, 6.783045e+004, 7.010820e+004, 6.930487e+004, 9.436356e+004, 1.107674e+005, 1.492925e+005, 1.480771e+005, 1.664762e+005, 
    1.659991e+005, 2.108224e+005, 3.223843e+005, 3.681304e+005, 3.155974e+005, 2.721486e+005, 2.460963e+005, 5.001770e+005, 3.802812e+005, 3.044773e+005, 3.234533e+005, 3.759482e+005, 2.865523e+005, 2.270181e+005, 2.476787e+005, 2.666653e+005, 2.059334e+005, 1.990849e+005, 2.009925e+005, 1.382856e+005, 1.260161e+005, 1.899175e+005, 2.412469e+005, 1.955221e+005, 2.923659e+005, 
    2.286043e+005, 1.453515e+005, 1.057933e+005, 6.552942e+004, 5.344101e+004, 5.174865e+004, 5.656580e+004)),
  .Names = c("year", "recruits", "R.no.devs", "logR.dev", "SR.std.resid", "SSB"),
  row.names = c("1965", "1966", "1967", "1968", "1969", "1970", "1971", "1972", "1973", "1974", "1975", "1976", "1977", "1978", "1979", "1980", "1981", "1982", "1983", "1984", "1985", "1986", "1987", "1988", "1989",
                "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014",
                "2015", "2016", "2017", "2018", "2019", "2020", "2021"),
  class = "data.frame")

# Load in the stock recruit parameters and time series
SR.parms = structure(list(
  SR.alpha = 3.055699e+006,
  SR.beta = 1.229469e+003,
  SR.SPR0 = 1.593317e-001,
  SR.S0 = 4.856404e+005,
  SR.R0 = 3.047983e+006,
  SR.steepness = 9.900000e-001),
  .Names = c("SR.alpha", "SR.beta", "SR.SPR0", "SR.S0", "SR.R0", "SR.steepness"))

SR.annual.parms = structure(list(
  year = c(1965, 1966, 1967, 1968, 1969, 1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, 1979, 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989, 
           1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 
           2015, 2016, 2017, 2018, 2019, 2020, 2021),
  S0.vec = c(6.323496e+005, 7.004619e+005, 6.688289e+005, 6.888035e+005, 6.416437e+005, 7.078693e+005, 7.068881e+005, 8.006940e+005, 8.634135e+005, 7.397474e+005, 7.683233e+005, 7.619039e+005, 6.831010e+005, 6.647857e+005, 7.806485e+005, 7.518184e+005, 7.654084e+005, 8.327348e+005, 8.938716e+005, 8.331311e+005, 7.924119e+005, 7.140573e+005, 6.640522e+005, 6.380901e+005, 6.795792e+005, 
             6.093525e+005, 5.750267e+005, 5.827586e+005, 5.651221e+005, 4.992334e+005, 5.023626e+005, 4.967103e+005, 5.977108e+005, 4.941710e+005, 4.505389e+005, 5.365698e+005, 5.330495e+005, 4.814566e+005, 5.036458e+005, 5.339377e+005, 5.492268e+005, 4.929279e+005, 5.608752e+005, 5.443670e+005, 5.379758e+005, 5.006223e+005, 4.534117e+005, 4.596733e+005, 4.650144e+005, 5.235133e+005, 
             5.083897e+005, 4.374069e+005, 4.838645e+005, 5.801878e+005, 5.949365e+005, 5.659892e+005, 4.856404e+005),
  R0.vec = c(3.049770e+006, 3.050345e+006, 3.050092e+006, 3.050255e+006, 3.049855e+006, 3.050401e+006, 3.050394e+006, 3.051014e+006, 3.051354e+006, 3.050629e+006, 3.050817e+006, 3.050776e+006, 3.050209e+006, 3.050058e+006, 3.050894e+006, 3.050710e+006, 3.050799e+006, 3.051194e+006, 3.051502e+006, 3.051197e+006, 3.050965e+006, 3.050447e+006, 3.050052e+006, 3.049823e+006, 3.050181e+006, 
             3.049546e+006, 3.049180e+006, 3.049266e+006, 3.049066e+006, 3.048192e+006, 3.048239e+006, 3.048154e+006, 3.049427e+006, 3.048116e+006, 3.047383e+006, 3.048714e+006, 3.048668e+006, 3.047916e+006, 3.048258e+006, 3.048679e+006, 3.048874e+006, 3.048097e+006, 3.049016e+006, 3.048813e+006, 3.048732e+006, 3.048213e+006, 3.047436e+006, 3.047548e+006, 3.047641e+006, 3.048540e+006, 
             3.048327e+006, 3.047134e+006, 3.047955e+006, 3.049238e+006, 3.049397e+006, 3.049076e+006, 3.047983e+006),
  steepness.vec = c(9.922977e-001, 9.930402e-001, 9.927140e-001, 9.929234e-001, 9.924082e-001, 9.931124e-001, 9.931029e-001, 9.939048e-001, 9.943444e-001, 9.934067e-001, 9.936500e-001, 9.935969e-001, 9.928649e-001, 9.926701e-001, 9.937495e-001, 9.935117e-001, 9.936260e-001, 9.941376e-001, 9.945358e-001, 9.941404e-001, 9.938416e-001, 9.931716e-001, 9.926621e-001, 9.923664e-001, 9.928282e-001, 
                    9.920099e-001, 9.915380e-001, 9.916491e-001, 9.913913e-001, 9.902690e-001, 9.903288e-001, 9.902201e-001, 9.918559e-001, 9.901705e-001, 9.892314e-001, 9.909384e-001, 9.908793e-001, 9.899142e-001, 9.903532e-001, 9.908943e-001, 9.911449e-001, 9.901460e-001, 9.913268e-001, 9.910668e-001, 9.909618e-001, 9.902956e-001, 9.892987e-001, 9.894426e-001, 9.895622e-001, 9.907150e-001, 
                    9.904421e-001, 9.889126e-001, 9.899638e-001, 9.916125e-001, 9.918183e-001, 9.914044e-001, 9.900000e-001),
  s.per.r.vec = c(2.073434e-001, 2.296337e-001, 2.192815e-001, 2.258184e-001, 2.103850e-001, 2.320578e-001, 2.317367e-001, 2.624353e-001, 2.829608e-001, 2.424901e-001, 2.518418e-001, 2.497410e-001, 2.239522e-001, 2.179583e-001, 2.558753e-001, 2.464404e-001, 2.508879e-001, 2.729209e-001, 2.929284e-001, 2.730506e-001, 2.597250e-001, 2.340829e-001, 2.177183e-001, 2.092220e-001, 2.227996e-001, 
                  1.998174e-001, 1.885841e-001, 1.911144e-001, 1.853427e-001, 1.637801e-001, 1.648042e-001, 1.629544e-001, 1.960076e-001, 1.621234e-001, 1.478445e-001, 1.759988e-001, 1.748467e-001, 1.579626e-001, 1.652241e-001, 1.751374e-001, 1.801409e-001, 1.617166e-001, 1.839529e-001, 1.785504e-001, 1.764589e-001, 1.642347e-001, 1.487846e-001, 1.508338e-001, 1.525817e-001, 1.717259e-001, 
                  1.667766e-001, 1.435470e-001, 1.587506e-001, 1.902731e-001, 1.950997e-001, 1.856265e-001, 1.593317e-001)),
  .Names = c("year", "S0.vec", "R0.vec", "steepness.vec", "s.per.r.vec"),
  row.names = c("1965", "1966", "1967", "1968", "1969", "1970", "1971", "1972", "1973", "1974", "1975", "1976", "1977", "1978", "1979", "1980", "1981", "1982", "1983", "1984", "1985", "1986", "1987", "1988", "1989",
                "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014",
                "2015", "2016", "2017", "2018", "2019", "2020", "2021"),
  class = "data.frame")
6.323496e+005/3.049770e+006
# Plots -------------------------------------------------------------------

#Calculate Recruits/Spawner (R/SSB) Prob don't need
herring <- herring %>%
  mutate(RPS = recruits/SSB)

#Calculate Spawning Success Rs (lnRt/ssb-1)
herring$Rs <- NA
for(i in 2:nrow(herring)){
  herring$Rs[i] <- log(herring$recruits[i]/herring$SSB[i-1])
}

# Make named plots for each variable
rec <- ggplot(herring, aes(x = year, y = recruits))  + 
  theme_bw() +  
  geom_point(na.rm = F, size=3)+
  geom_line() +
  xlab("Year") +
  ylab("Recruitment")

nodev <- ggplot(herring, aes(x = year, y = R.no.devs))  + 
  theme_bw() +  
  geom_point(na.rm = F, size=3)+
  geom_line() +
  xlab("Year") +
  ylab("Recruitment (No devs)")

devs <- ggplot(herring, aes(x = year, y = logR.dev))  + 
  theme_bw() +  
  geom_point(na.rm = F, size=3)+
  geom_line() +
  xlab("Year") +
  ylab("Log Recruitment Deviations")

srresid <- ggplot(herring, aes(x = year, y = SR.std.resid))  + 
  theme_bw() +  
  geom_point(na.rm = F, size=3)+
  geom_line() +
  xlab("Year") +
  ylab("Stock-Recruit Residuals (Standardized)")

ssb <- ggplot(herring, aes(x = year, y = SSB))  + 
  theme_bw() +  
  geom_point(na.rm = F, size=3)+
  geom_line() +
  xlab("Year") +
  ylab("SSB")

SPR <- ggplot(SR.annual.parms, aes(x = year, y = s.per.r.vec))  + 
  theme_bw() +  
  geom_point(na.rm = F, size=3)+
  geom_line() +
  xlab("Year") +
  ylab("Spawner Per Recruit")

Succ <- ggplot(herring, aes(x = year, y = Rs))  + 
  theme_bw() +  
  geom_point(na.rm = F, size=3)+
  geom_line() +
  xlab("Year") +
  ylab("Recruitment Success")

# Plot all in one panel
ggarrange(SPR, ssb, srresid, devs, nodev, rec, Succ)


# Canonical correlation analysis

# first split into two datasets
fish <- multivariate[, 1:7]
pars <- multivariate[, 8:14]
matcor(fish, pars)
# from first part I already see strong correlations btwn environmental variables, now pick which ones are most important
cc1 <- cc(fish, pars)
cc1$cor
